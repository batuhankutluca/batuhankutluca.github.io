---
layout: post
title: "Excel 4.0 Zararlı Macro Analizi"
feature-img: 'assets/img/excel4.0/bg.png'
date: 2020-04-10 14:00:00
author: batuhankutluca
tags: [Malicious, Macro, Analysis, Excel, 4.0, Very Hidden, Oledump]
---

<p align="justify">Herkese selam. Bu yazıda sizleri son zamanda örnekleri çokça artan, VirusTotal ve çeşitli analiz ortamlarında hala çok az sayıda detectiona sahip olan Excel 4.0 Macro içeren zararlı XLS dosyalarının analizi hakkında elimden geldiğince aydınlatmaya çalışacağım.</p>

<p align="justify">Konuya giriş yapmadan önce analiz sırasında kullanacağımız toolları ve zararlı dosyaları indirebileceğiniz linklere aşağıdan ulaşabilirsiniz.</p>

* [Zararlı Excel Dosyaları][maldoc]
* [oledump.py][oledump]
* [plugin_biff.py][plugin_biff]
* [Biff View][biffview]
* [Oletools][oletools]
* [Excel 4 Macro Reference][ref]

<p align="justify">Normal bir Office dosyasında makro oluşturduğunuzda VBA yani Visual Basic formatında oluşur. Dolayısıyla çoğu ole toolu sayesinde bu VBA kodunu dump edip çalıştırılacak makroları görebiliriz. Ancak Excel 4.0 makro formatında oluşturulan bir dosyada bu yöntem işe yaramayacaktır çünkü makro formatı VBA değildir. VBA, Excel Versiyon 5 ile birlikte gelmiştir. Bu versiyondaki makrolar BIFF kayıtları şeklinde tutuluyor.</p>

<p align="justify">Excel 4 formatında makrolar bir Excel sayfası(worksheet) içindeki hücrelere yerleştirilmiş fonksiyon tipindedir. Dolayısıyla makrolara VBA incelemesi yapar gibi GUI aracılığıyla makro penceresinden değil, Excel sayfaları içinden erişmemiz gerekiyor. Fakat birazdan inceleyeceğimiz örnekteki gibi makro içeren sayfa "hidden" veya "very hidden" şeklinde olabilir. Bu sayfaları "visible" konuma getirmek GUI aracılığıyla mümkün olmayacaktır. Bunun için de BiffView tooluyla birkaç değişiklik yapacağız.</p>

<p align="justify">Çok fazla kavram ve detayda boğulmamak amacıyla ilk sampleımızı incelemeye başlayalım. Detaylı bilgi için üst paragraftaki kavramları araştırabilirsiniz.</p>

![img]({{ site.baseurl }}/assets/img/excel4.0/1.png)

<p align="justify">Dosyayı açtığımızda önümüze tipik phishing saldırılarında geçen, default olarak disabled olan makroları enable etmemizi söyleyen bir görselle karşılaşıyoruz. Normal bir dosya gibi davranıp GUI aracılığıyla makroları incelemeye çalışalım. </p>

![img]({{ site.baseurl }}/assets/img/excel4.0/2.png)

<p align="justify">Herhangi bir makro görememekteyiz. Daha sonra analizimize olevba ve oledump ile devam edelim. Konsol ekranından olevba aracılığıyla dosyamızı verip çıktısını kaydedelim.</p>

![img]({{ site.baseurl }}/assets/img/excel4.0/3.png)

![img]({{ site.baseurl }}/assets/img/excel4.0/4.png)

<p align="justify">Olevba önceden de belirttiğim gibi adından da anlaşılacağı üzere VBA makrolarını extract etmek için oluşturulmuştur ancak Makro4'te de belli başlı şeyler için bize yol gösterecektir. Çıktıyı incelemeye başladığımızda ilk dikkatimizi çeken şey Excel dosyamızda "very hidden" özelliğine sahip bir worksheetin bulunması olacaktır. Bir üstteki satırda "visible" olarak bulunan worksheet, dosyamızı açtığımızda karşımıza gelen worksheettir ve burada makro bulunmamaktadır. Dolayısıyla burada makromuzun "very hidden" worksheetin içinde olduğunu anlıyoruz. Worksheetlerde görünürlük özelliği 3 tipte bulunmaktadır. </p>

* Visible (GUI aracılığıyla etkileşim kurabildiğimiz worksheet tipi)
* Hidden (Yine GUI aracılığıyla "visible" konumundan "hidden" konumuna ve "hidden" konumundan "visible" konumuna çekilebilen worksheet tipi)
* Very Hidden (GUI üzerinden "visible" konumuna çekilemeyen, mecburen binary üzerinde değişiklik yapmak zorunda olduğumuz worksheet tipi)

![img]({{ site.baseurl }}/assets/img/excel4.0/5.png)

<p align="justify">Aşağılara doğru indikçe birtakım char kodları ve bunların değerleri hakkında bilgiler bulunuyor. Buradan asıl çalışacak makromuzun Char kodlardan çevirildiğini anlıyoruz. En aşağıda makromuzun Auto_Open fonksiyonuna sahip olduğunu anlıyoruz. Yani sandboxlardaki gibi default olarak makrolar çalıştırılmaya ayarlı şekilde olsaydı, dosya açılır açılmaz veya biz makroları enable eder etmez otomatik olarak  makrolar çalışacaktı. Auto_Open fonksiyonu bu işe yarıyor. Son olarak EXEC fonksiyonu bulunduğunu ve bu fonksiyonun Makro4'te kullanılabileceği bilgisi karşımıza çıkıyor. Dosya tipini ve şüpheli birkaç olayı tespit ettikten sonra analizimize worksheetimizi "visible" hale getirmekle devam edeceğiz.</p>

![img]({{ site.baseurl }}/assets/img/excel4.0/6.png)

<p align="justify">BiffExplorer toolumuzu açıp dosyamızı seçiyoruz. Daha sonra create butonuna basıyoruz. </p>

![img]({{ site.baseurl }}/assets/img/excel4.0/7.png)

<p align="justify">Karşımıza dosyamızın BIFF kayıtlarıyla alakalı bir html dosyası çıkıyor.</p>

![img]({{ site.baseurl }}/assets/img/excel4.0/8.png)

<p align="justify">Burada aramamız gereken keyword "BOUNDSHEET" olacaktır. Çünkü worksheet dosyaları BIFF kayıtlarında "BOUNDSHEET" olarak geçmektedir.</p>


[maldoc]: https://github.com/batuhankutluca/Excel-4.0-Maldoc-Samples
[oledump]: https://github.com/DidierStevens/DidierStevensSuite/blob/master/oledump.py
[plugin_biff]: https://github.com/DidierStevens/DidierStevensSuite/blob/master/plugin_biff.py
[biffview]: https://www.aldeid.com/wiki/BiffView
[oletools]: https://github.com/decalage2/oletools/wiki/Install
[ref]: https://d13ot9o61jdzpp.cloudfront.net/files/Excel%204.0%20Macro%20Functions%20Reference.pdf